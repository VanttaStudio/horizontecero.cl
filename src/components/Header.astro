---
import ThemeSwitcher from './ThemeSwitcher.astro';

const currentPath = Astro.url.pathname;

const isActive = (path: string) => {
    if (path === '/') return currentPath === '/';
    return currentPath.startsWith(path);
};

const links = [
    { href: '/', label: 'Inicio' },
    { href: '/tienda', label: 'Tienda' },
    { href: '/cursos', label: 'Cursos', badge: 'Cupos Limitados' }
];
---

<header 
    id="site-header" 
    class="fixed top-0 left-0 w-full z-50 transition-all duration-500 ease-[cubic-bezier(0.4,0,0.2,1)] border-b border-transparent"
    data-scrolled="false"
>
    <div class="container mx-auto px-6 h-24 flex justify-between items-center">
        
        {/* LOGO CON DOBLE ESTADO */}
        <a href="/" aria-label="Volver al inicio" class="flex-shrink-0 group relative z-50 w-40 h-12 block">
             <img 
                src="/images/logonoche.png" 
                alt="Horizonte Cero" 
                class="absolute inset-0 w-full h-full object-contain transition-all duration-500 logo-white"
            />
            <img 
                src="/images/logodia.png" 
                alt="Horizonte Cero" 
                class="absolute inset-0 w-full h-full object-contain transition-all duration-500 opacity-0 logo-dark"
            />
        </a>

        {/* NAVEGACIÓN DESKTOP */}
        <div class="flex items-center gap-4">
            <nav class="hidden md:flex items-center gap-1 p-1 rounded-full" id="nav-menu">
                {links.map((link) => {
                    const active = isActive(link.href);
                    return (
                        <a 
                            href={link.href} 
                            class:list={[
                                "relative px-5 py-2.5 text-sm font-bold rounded-full transition-all duration-300 group nav-link overflow-hidden flex items-center gap-2",
                                active ? "active" : ""
                            ]}
                        >
                            <span class="absolute inset-0 bg-current opacity-0 group-hover:opacity-10 transition-opacity duration-300 rounded-full"></span>
                            <span class="relative z-10">{link.label}</span>
                            
                            {link.badge && (
                                <span class="relative z-10 px-2 py-0.5 text-[8px] font-black uppercase tracking-tighter bg-[var(--color-secondary)] text-stone-900 rounded-full animate-pulse">
                                    {link.badge}
                                </span>
                            )}

                            {active && (
                                <span class="absolute bottom-1.5 left-1/2 -translate-x-1/2 w-1.5 h-1.5 bg-[var(--color-secondary)] rounded-full shadow-[0_0_10px_var(--color-secondary)]"></span>
                            )}
                        </a>
                    )
                })}
            </nav>

            <div class="hidden md:block w-px h-6 bg-white/20 divider mx-2"></div>

            <ThemeSwitcher />

            {/* BOTÓN MENÚ MÓVIL */}
            <button 
                id="mobile-menu-btn"
                class="md:hidden relative w-10 h-10 flex items-center justify-center text-white focus:outline-none z-50"
                aria-label="Abrir menú"
                aria-expanded="false"
            >
                <div class="relative w-6 h-5">
                    <span class="absolute top-0 left-0 w-full h-0.5 bg-current rounded-full transition-all duration-300 origin-center hamburger-top"></span>
                    <span class="absolute top-1/2 left-0 w-full h-0.5 bg-current rounded-full -translate-y-1/2 transition-opacity duration-300 hamburger-middle"></span>
                    <span class="absolute bottom-0 left-0 w-full h-0.5 bg-current rounded-full transition-all duration-300 origin-center hamburger-bottom"></span>
                </div>
            </button>
        </div>
    </div>

    {/* MENÚ MÓVIL (Overlay Glass) */}
    <div 
        id="mobile-menu" 
        class="fixed inset-0 z-40 bg-[#F0EEE5]/95 dark:bg-slate-900/95 backdrop-blur-2xl transform translate-x-full transition-transform duration-500 ease-[cubic-bezier(0.33,1,0.68,1)] flex flex-col items-center justify-center space-y-8"
    >
        <div class="absolute top-0 right-0 w-64 h-64 bg-[var(--color-secondary)]/10 rounded-full blur-3xl pointer-events-none"></div>

        {links.map((link, index) => (
            <a 
                href={link.href} 
                class="relative flex flex-col items-center gap-2 group mobile-link transform translate-y-4 opacity-0 transition-all duration-500"
                style={`transition-delay: ${index * 50}ms`}
            >
                <span class="text-4xl font-black text-stone-800 dark:text-white group-hover:text-[var(--color-secondary)] transition-colors">
                    {link.label}
                </span>
                {link.badge && (
                    <span class="px-3 py-1 text-[10px] font-black uppercase tracking-widest bg-[var(--color-secondary)] text-stone-900 rounded-full shadow-lg">
                        {link.badge}
                    </span>
                )}
            </a>
        ))}
    </div>
</header>

<style>
    #site-header { background-color: transparent; border-color: transparent; }
    .nav-link { color: white; }
    .logo-white { opacity: 1; transform: translateY(0); }
    .logo-dark { opacity: 0; transform: translateY(10px); }
    #mobile-menu-btn { color: white; }
    .divider { background-color: rgba(255, 255, 255, 0.2); }

    /* ESTADO SCROLLED MODO DÍA */
    :global(html:not(.dark)) #site-header[data-scrolled="true"] {
        background-color: rgba(240, 238, 229, 0.85); 
        backdrop-filter: blur(20px);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
        border-bottom-color: rgba(0, 0, 0, 0.05);
    }
    :global(html:not(.dark)) #site-header[data-scrolled="true"] .nav-link { color: #44403C; }
    :global(html:not(.dark)) #site-header[data-scrolled="true"] #mobile-menu-btn { color: #44403C; }
    :global(html:not(.dark)) #site-header[data-scrolled="true"] .divider { background-color: rgba(68, 64, 60, 0.2); }
    :global(html:not(.dark)) #site-header[data-scrolled="true"] .logo-white { opacity: 0; transform: translateY(-10px); }
    :global(html:not(.dark)) #site-header[data-scrolled="true"] .logo-dark { opacity: 1; transform: translateY(0); }

    /* ESTADO SCROLLED MODO NOCHE */
    :global(.dark) #site-header[data-scrolled="true"] {
        background-color: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(20px);
        border-bottom-color: rgba(255, 255, 255, 0.05);
    }

    #mobile-menu-btn[aria-expanded="true"] .hamburger-top { transform: rotate(45deg) translate(5px, 6px); }
    #mobile-menu-btn[aria-expanded="true"] .hamburger-middle { opacity: 0; }
    #mobile-menu-btn[aria-expanded="true"] .hamburger-bottom { transform: rotate(-45deg) translate(5px, -6px); }

    #mobile-menu.open .mobile-link {
        opacity: 1;
        transform: translateY(0);
    }
</style>

<script is:inline>
    document.addEventListener('astro:page-load', () => {
        const header = document.getElementById('site-header');
        const btn = document.getElementById('mobile-menu-btn');
        const menu = document.getElementById('mobile-menu');
        
        const updateHeaderState = () => {
            if (!header) return;
            const isScrolled = window.scrollY > 20;
            if (header.getAttribute('data-scrolled') !== String(isScrolled)) {
                header.setAttribute('data-scrolled', String(isScrolled));
            }
        };

        window.addEventListener('scroll', updateHeaderState, { passive: true });
        updateHeaderState();

        if (btn && menu) {
            btn.onclick = () => {
                const isExpanded = btn.getAttribute('aria-expanded') === 'true';
                btn.setAttribute('aria-expanded', String(!isExpanded));
                menu.classList.toggle('translate-x-full');
                menu.classList.toggle('open');
                document.body.style.overflow = !isExpanded ? 'hidden' : '';
            };

            menu.querySelectorAll('a').forEach(link => {
                link.onclick = () => { btn.click(); };
            });
        }
    });
</script>